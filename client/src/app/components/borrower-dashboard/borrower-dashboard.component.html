<div class="container mt-5">
  <h2 class="text-center mb-4">Borrower Dashboard</h2>

  <div class="d-flex justify-content-center mb-4">
    <div class="card reputation-card shadow p-4">
      <div 
        class="reputation-score-circle" 
        [ngClass]="{
          'circle-red': reputationScore >= 1 && reputationScore <= 40,
          'circle-yellow': reputationScore >= 41 && reputationScore <= 70,
          'circle-green': reputationScore >= 71 && reputationScore <= 100
        }">
          {{reputationScore}}%
      </div>
    </div>
  </div>
  <div class="mt-3 mb-5 text-center">
    <h5>Your Reputation Score</h5>
  </div>

  <!-- My Loan Applications Table -->
  <h3 class="mb-4 ">My Loan Applications and Loans</h3>
  <div *ngIf="loanApplications.length > 0; else noApplications" class="table-responsive">
    <table class="table table-striped table-bordered">
      <thead class="thead-light">
        <tr>
          <th scope="col">Principal Amount</th>
          <th scope="col">Interest (%)</th>
          <th scope="col">Payment Term (Years)</th>
          <th scope="col">Monthly Repayment</th>
          <th scope="col">Total Repayment Amount</th>
          <th scope="col">Status</th>
          <th scope="col">Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let application of loanApplications">
          <td>{{ application.loanOffer.principalAmount | currency: 'R':'symbol' }}</td>
          <td>{{ application.loanOffer.interestRate }}%</td>
          <td>{{ application.loanOffer.durationInYears }}</td>
          <td>{{ application.loanOffer.monthlyRepayment | currency:'R':'symbol'}}</td>
          <td>{{ application.loanOffer.totalRepayment | currency:'R':'symbol'}}</td>
          <td>
            <span *ngIf="application.status === 0">Pending</span>
            <span *ngIf="application.status === 1">Approved</span>
            <span *ngIf="application.status === 2">Rejected</span>
            <span *ngIf="application.status === 3">Withdrawn</span>
          </td>
          <td>
            <button *ngIf="application.status === 1" class="btn btn-outline-success btn-sm" (click)="openPaymentModal(application.loanOffer.id)">Make Payment</button>
            <button *ngIf="application.status === 0" class="btn btn-outline-success btn-sm" (click)="withdrawApplication(application.id)">Withdraw</button>
          </td>
        </tr>
        
        <!-- Accordion for displaying payments -->
        <tr *ngFor="let application of loanApplications">
          <td colspan="8">
            <div class="accordion" id="accordionExample">
              <div class="accordion-item">
                <h2 class="accordion-header" id="heading{{application.id}}">
                  <button class="accordion-button collapsed" 
                  type="button" data-bs-toggle="collapse" 
                          [attr.data-bs-target]="'#collapse' + application.id" 
                          aria-expanded="false" 
                          [attr.aria-controls]="'collapse' + application.id">
                    View Payments for Loan of {{ application.loanOffer.principalAmount | currency: 'R':'symbol'}}
                  </button>
                </h2>
                <div [id]="'collapse' + application.id" class="accordion-collapse collapse" 
                     [attr.aria-labelledby]="'heading' + application.id" data-bs-parent="#accordionExample">
                  <div class="accordion-body">
                    <div *ngIf="paymentsByLoan[application.loanOfferId].length > 0; else noPayments">
                      <table class="table table-striped table-bordered">
                        <thead>
                          <tr>
                            <th scope="col">Amount</th>
                            <th scope="col">Payment Date</th>
                            <th scope="col">Remaining Balance</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr *ngFor="let payment of paymentsByLoan[application.loanOfferId].slice().reverse()">
                            <td>{{ payment.amount | currency: 'R':'symbol' }}</td>
                            <td>{{ payment.paymentDate | date: 'medium' }}</td>
                            <td>{{ payment.balance | currency: 'R':'symbol'}}</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                    <ng-template #noPayments>
                      <div class="alert alert-info" role="alert">No payments made for this loan application yet.</div>
                    </ng-template>
                  </div>
                </div>
              </div>
            </div>
          </td>
        </tr>

        
        
      </tbody>
    </table>
  </div>
  <ng-template #noApplications>
    <div class="alert alert-info" role="alert">
      You currently have no loan applications. Would you like to <a href="/apply" class="alert-link" routerLink="/loan-offers">apply for a loan</a>?
    </div>
  </ng-template>
</div>
