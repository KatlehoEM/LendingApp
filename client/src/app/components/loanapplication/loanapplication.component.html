<div class="container mt-5">
  <h3 class="mb-4">Loan Applications for Offer ID: {{ loanOfferId }}</h3>
  
  <div *ngIf="loanApplicationDtos.length > 0; else noApplications" class="table-responsive">
    <table class="table table-striped table-bordered">
      <thead class="table-light">
        <tr>
          <th scope="col">Applicant Name</th>
          <th scope="col">Reputation Score (%)</th>
          <th scope="col">Credit Score</th>
          <th scope="col">Status</th>
          <th scope="col">Rating</th>
          <th scope="col">Actions</th>
        </tr>
      </thead>
      <tbody>
        <!-- Main data row -->
        <tr *ngFor="let application of loanApplicationDtos; let i = index">
          <td>{{ application.borrowerName }}</td>
          <td>
            <div [ngClass]="{
              'circle-red': application.borrowerReputationScore >= 1 && application.borrowerReputationScore <= 40,
              'circle-yellow': application.borrowerReputationScore >= 41 && application.borrowerReputationScore <= 70,
              'circle-green': application.borrowerReputationScore >= 71 && application.borrowerReputationScore <= 100
            }" class="reputation-circle">
              {{application.borrowerReputationScore}}%
            </div>
          </td>
          <td>
            <div [ngClass]="{
                'circle-poor': application.creditScore >= 300 && application.creditScore <= 579,
                'circle-fair': application.creditScore >= 580 && application.creditScore <= 669,
                'circle-good': application.creditScore >= 670 && application.creditScore <= 739,
                'circle-excellent': application.creditScore >= 740 && application.creditScore <= 850
              }" class="credit-circle">
              {{ application.creditScore }}
            </div>
          </td>
          <td>
            <span *ngIf="application.applicationStatus === loanApplicationStatus.Pending">Pending</span>
            <span *ngIf="application.applicationStatus === loanApplicationStatus.Approved">Approved</span>
            <span *ngIf="application.applicationStatus === loanApplicationStatus.Rejected">Rejected</span>
          </td>
          <td>
            <app-star-rating *ngIf="application.applicationStatus === loanApplicationStatus.Approved"
                             [(rating)]="userRating"
                             (ratingChange)="onRatingChange(application.id, $event)">
            </app-star-rating>
          </td>
          <td>
            <button *ngIf="application.applicationStatus === loanApplicationStatus.Pending" class="btn btn-success btn-sm me-2" (click)="updateStatus(application.id, loanApplicationStatus.Approved)">Approve</button>
            <button *ngIf="application.applicationStatus === loanApplicationStatus.Pending" class="btn btn-danger btn-sm" (click)="updateStatus(application.id, loanApplicationStatus.Rejected)">Reject</button>
          </td>
        </tr>
        
        <!-- Accordion for Payments (inside the same ngFor loop) -->
        <tr *ngFor="let application of loanApplicationDtos">
          <td colspan="6">
            <div *ngIf="application.applicationStatus === loanApplicationStatus.Approved" class="accordion" id="accordionExample">
              <div class="accordion-item">
                <h2 class="accordion-header" id="heading{{application.id}}">
                  <button class="accordion-button collapsed"
                   type="button" data-bs-toggle="collapse"
                    [attr.data-bs-target]="'#collapse' + application.id"
                      aria-expanded="false" [attr.aria-controls]="'collapse' + application.id">
                    View Payments for {{ application.borrowerName }}
                  </button>
                </h2>
                <div [id]="'collapse' + application.id" class="accordion-collapse collapse" 
                [attr.aria-labelledby]="'heading' + application.id" data-bs-parent="#accordionExample">
                  <div class="accordion-body">
                    <div *ngIf="paymentsByLoan[application.loanOfferId].length > 0; else noPayments">
                      <table class="table table-bordered">
                        <thead>
                          <tr>
                            <th scope="col">Amount</th>
                            <th scope="col">Payment Date</th>
                            <th scope="col">Remaining Balance</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr *ngFor="let payment of paymentsByLoan[application.loanOfferId].slice().reverse()">
                            <td>{{ payment.amount | currency: 'R':'symbol' }}</td>
                            <td>{{ payment.paymentDate | date: 'medium' }}</td>
                            <td>{{ payment.balance | currency: 'R':'symbol' }}</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                    <ng-template #noPayments>
                      <div class="alert alert-warning">
                        No payments found for this application.
                      </div>
                    </ng-template>
                  </div>
                </div>
              </div>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <ng-template #noApplications>
    <div class="alert alert-info" role="alert">
      There are currently no applications for this loan offer.
    </div>
  </ng-template>
</div>
